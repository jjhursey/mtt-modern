#
# Template MTT configuration file for MTT users.  The intent
# for this template file is to establish at least some loose
# guidelines for what MTT users should be running
# before committing changes to the OMPI repository. This file is not
# intended to be an exhaustive sample of all possible fields and
# values that MTT offers. Each developer will undoubtedly have to
# edit this template for their own needs (e.g., pick compilers to use,
# etc.), but this file provides a baseline set of configurations that
# we intend for you to run.
#
# Sample usage:
#   cat developer.ini intel.ini   | client/mtt - alreadyinstalled_dir=/your/install
#   cat developer.ini trivial.ini | client/mtt - alreadyinstalled_dir=/your/install
#

[MTTDefaults]

force = 1
trial = 0
scratch = mttscratch
submit_group_results = 1
logfile = mtt-logfile-mpitest.txt
description = Prototype test configuration file

#======================================================================
# Middleware construction phases - get the middleware, build, and
# install it. This isn't a required phase - if the purpose of this test
# is to simply stress the physical system, then one can skip this phase
#======================================================================

#----------------------------------------------------------------------

[MiddlewareGet:Installed]
# Do not include a prefix parameter to
# have MTT search your path for an target
# prefix = /your/installation
plugin = AlreadyInstalled
exec = mpirun

#----------------------------------------------------------------------

[MiddlewareBuild:Installed]
plugin = AlreadyInstalled
parent = MiddlewareGet:Installed

#======================================================================
# Test construction phases - get and build the tests that the
# target software will run.
#======================================================================

[TestGet:IBM]
plugin = Git
url =  https://github.com/open-mpi/ompi-tests
username = rhc54
pwfile = rhcpasswd
subdir = ibm


#----------------------------------------------------------------------

[SKIP TestGet:Intel]
plugin = Git
url =  https://github.com/open-mpi/ompi-tests
subdir = intel_tests


#
#======================================================================
# Test build phase
#======================================================================

#----------------------------------------------------------------------

[ASIS TestBuild:IBMInstalled]
parent = TestGet:IBM
save_stdout_on_success = 1
merge_stdout_stderr = 1
stderr_save_lines = 100

middleware = MiddlewareBuild:Installed

autogen_cmd = "./autogen.sh"
configure_options = "CC=mpicc CXX=mpic++ F77=mpif77"
make_options = "-j 10"

#======================================================================
# Define some default launcher execution parameters
#======================================================================

[LauncherDefaults:OMPI]
plugin = OpenMPI
command = mpirun
np = 16

options = ["", "--novm"]

skipped = 77

save_stdout_on_pass = 1
merge_stdout_stderr = 1
stdout_save_lines = 100
stderr_save_lines = 100
report_after_n_results = 100

#
#======================================================================
# Test run phase - the executor will automatically change directory to
# the top directory where the tests were installed, so any search for
# executables will take place relative to that point
#======================================================================

#----------------------------------------------------------------------

[TestRun:IBMInstalledOMPI]
plugin = OpenMPI
parent = TestBuild:IBMInstalled
timeout = 600
#test_dir = "collective, communicator, datatype, environment, group, info, io, onesided, pt2pt, random, topology"
test_dir = "collective, communicator"
max_num_tests = 10

# Tests that are supposed to fail
fail_tests = "environment/abort, environment/final"
fail_timeout = max_procs

#
# THREAD_MULTIPLE test will fail with the openib btl because it
# deactivates itself in the presence of THREAD_MULTIPLE.  So just skip
# it.  loop_child is the target for loop_spawn, so we don't need to
# run it (although it'll safely pass if you run it by itself).
skip_tests = "environment/init_thread_multiple,communicator/comm_split_f"

#======================================================================
# Reporter phase
#======================================================================

[Reporter: IU database]
plugin = MTTDatabase

mttdatabase_realm = OMPI
mttdatabase_username = intel
mttdatabase_password = &stringify(&cat("/home/common/mttpwd.txt"))
mttdatabase_platform = bend-rsh
mttdatabase_hostname = &env_hosts()
mttdatabase_url = https://mtt.open-mpi.org/submit/
mttdatabase_debug_filename = mttdb_debug_file
mttdatabase_keep_debug_files = 1
mttdatabase_debug_server = 1

#----------------------------------------------------------------------

[Reporter: text file backup]
plugin = TextFile

textfile_filename = $phase-$section-$mpi_name-$mpi_version.txt

# User-defined report headers/footers
#textfile_summary_header = <<EOT
#hostname: &shell("hostname")
#uname: &shell("uname -a")
#who am i: &shell("who am i")
#EOT

textfile_summary_footer =
textfile_detail_header  =
textfile_detail_footer  =

textfile_textwrap = 78
